<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Databricks Feature Preview Status Tracker</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            padding: 24px;
        }
        h1 { font-size: 1.6rem; margin-bottom: 8px; }
        .subtitle { color: #8b949e; font-size: 0.9rem; margin-bottom: 20px; }
        .disclaimer {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .giscus-explainer {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.82rem;
            color: #8b949e;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .giscus-explainer summary {
            cursor: pointer;
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .giscus-explainer summary:hover { color: #58a6ff; }
        .giscus-explainer p { margin-top: 10px; }
        .giscus-explainer ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }
        .giscus-explainer ul li { margin-bottom: 4px; }

        /* Chip filter system */
        .chip-filters {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .chip-group {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px 14px;
        }
        .chip-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .chip-group-label {
            font-size: 0.78rem;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .chip-clear {
            font-size: 0.72rem;
            color: #8b949e;
            background: none;
            border: none;
            cursor: pointer;
            display: none;
            padding: 0;
        }
        .chip-clear:hover { color: #e6edf3; }
        .chip-clear.visible { display: inline; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #30363d;
            background: transparent;
            color: #8b949e;
            transition: all 0.15s ease;
            user-select: none;
        }
        .chip:hover { border-color: #58a6ff; color: #e6edf3; }
        .chip.active { color: #fff; }
        /* Status chip colors when active */
        .chip.active.chip-ga { background: #238636; border-color: #238636; }
        .chip.active.chip-ga-soon { background: #1a7f37; border-color: #3fb950; border-style: dashed; color: #d3f5d8; }
        .chip.active.chip-public-preview { background: #1f3a5f; border-color: #58a6ff; color: #58a6ff; }
        .chip.active.chip-beta { background: #4a2c0a; border-color: #d29922; color: #d29922; }
        .chip.active.chip-private-preview { background: #3d1e5c; border-color: #bc8cff; color: #bc8cff; }
        .chip.active.chip-experimental { background: #3d1e1e; border-color: #f47067; color: #f47067; }
        /* Risk chip colors when active */
        .chip.active.chip-risk-high { background: #3d1e1e; border-color: #f85149; color: #f85149; }
        .chip.active.chip-risk-medium { background: #4a2c0a; border-color: #d29922; color: #d29922; }
        .chip.active.chip-risk-low { background: #0f2d16; border-color: #3fb950; color: #3fb950; }
        /* Generic accent for category/source chips */
        .chip.active.chip-accent { background: #0d2240; border-color: #58a6ff; color: #58a6ff; }
        .chip-count {
            font-size: 0.68rem;
            background: rgba(255,255,255,0.1);
            padding: 1px 5px;
            border-radius: 8px;
            min-width: 18px;
            text-align: center;
        }
        .chip.active .chip-count { background: rgba(255,255,255,0.2); }
        @media (max-width: 600px) {
            .chip-filters { gap: 8px; }
            .chip-group { padding: 8px 10px; }
            .chip { padding: 3px 8px; font-size: 0.7rem; }
        }

        /* DataTables overrides for dark theme */
        table.dataTable { border-collapse: collapse; width: 100% !important; }
        table.dataTable thead th {
            background: #161b22;
            color: #e6edf3;
            border-bottom: 1px solid #30363d;
            padding: 10px 12px;
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
        }
        table.dataTable tbody td {
            background: #0d1117;
            color: #e6edf3;
            border-bottom: 1px solid #21262d;
            padding: 8px 12px;
            font-size: 0.82rem;
            vertical-align: top;
        }
        table.dataTable tbody tr:hover td { background: #161b22; }
        table.dataTable tbody td:nth-child(4) { max-width: 420px; } /* description (shifted by toggle col) */
        table.dataTable tbody td a { color: #58a6ff; text-decoration: none; }
        table.dataTable tbody td a:hover { text-decoration: underline; }

        /* Toggle column */
        td.dt-control {
            cursor: pointer;
            text-align: center;
            user-select: none;
        }
        td.dt-control .discuss-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            vertical-align: middle;
            opacity: 0.4;
            transition: opacity 0.15s;
        }
        td.dt-control .discuss-icon path { fill: #8b949e; }
        td.dt-control:hover .discuss-icon { opacity: 1; }
        td.dt-control:hover .discuss-icon path { fill: #58a6ff; }
        tr.shown td.dt-control .discuss-icon { opacity: 1; }
        tr.shown td.dt-control .discuss-icon path { fill: #58a6ff; }

        /* Expanded child row */
        table.dataTable tr.child-row td {
            background: #161b22;
            padding: 0;
        }
        .child-content {
            padding: 16px 24px 24px;
            border-left: 3px solid #58a6ff;
        }
        .child-content .feature-detail {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .child-content .feature-detail .detail-block {
            font-size: 0.82rem;
            color: #8b949e;
        }
        .child-content .feature-detail .detail-block strong { color: #e6edf3; }
        .child-content .feature-description {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #8b949e;
            margin-bottom: 16px;
            max-width: 800px;
        }
        .child-content .discuss-header {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            padding-top: 12px;
            border-top: 1px solid #30363d;
        }
        .child-content .open-discuss {
            display: inline-block;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #58a6ff;
            text-decoration: none;
        }
        .child-content .open-discuss:hover { text-decoration: underline; }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-ga { background: #238636; color: #fff; }
        .badge-ga-soon { background: #1a7f37; color: #d3f5d8; border: 1px dashed #3fb950; }
        .badge-public-preview { background: #1f3a5f; color: #58a6ff; }
        .badge-beta { background: #4a2c0a; color: #d29922; }
        .badge-private-preview { background: #3d1e5c; color: #bc8cff; }
        .badge-experimental { background: #3d1e1e; color: #f47067; }

        /* Risk badges */
        .risk-high { color: #f85149; font-weight: 600; }
        .risk-medium { color: #d29922; }
        .risk-low { color: #3fb950; }


        /* DataTables search & info */
        .dt-search { margin-bottom: 12px; }
        .dt-search input {
            background: #161b22; color: #e6edf3;
            border: 1px solid #30363d; border-radius: 6px;
            padding: 6px 12px; font-size: 0.85rem;
        }
        .dt-search input:focus { outline: 1px solid #58a6ff; border-color: #58a6ff; }
        .dt-search label { color: #8b949e; font-size: 0.85rem; }
        .dt-info { color: #8b949e; font-size: 0.82rem; padding: 8px 0; }
        .dt-paging { padding: 12px 0; }
        .dt-paging button {
            background: #161b22; color: #e6edf3;
            border: 1px solid #30363d; border-radius: 6px;
            padding: 4px 10px; margin: 0 2px; cursor: pointer; font-size: 0.82rem;
        }
        .dt-paging button:hover { border-color: #58a6ff; }
        .dt-paging button.current { background: #58a6ff; color: #0d1117; border-color: #58a6ff; }
        .dt-paging button.disabled { opacity: 0.4; cursor: default; }
        .dt-length { color: #8b949e; font-size: 0.82rem; margin-bottom: 8px; }
        .dt-length select {
            background: #161b22; color: #e6edf3;
            border: 1px solid #30363d; border-radius: 6px; padding: 4px 8px;
        }

        .stats { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card {
            background: #161b22; border: 1px solid #30363d; border-radius: 6px;
            padding: 12px 20px; text-align: center;
        }
        .stat-card .number { font-size: 1.4rem; font-weight: 700; }
        .stat-card .label { font-size: 0.75rem; color: #8b949e; margin-top: 2px; }

        /* SLA reference table */
        .sla-explainer {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.82rem;
            color: #8b949e;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .sla-explainer summary {
            cursor: pointer;
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .sla-explainer summary:hover { color: #58a6ff; }
        .sla-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.8rem;
        }
        .sla-table th {
            background: #0d1117;
            color: #e6edf3;
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid #30363d;
            font-weight: 600;
            white-space: nowrap;
        }
        .sla-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #21262d;
            vertical-align: top;
            color: #8b949e;
        }
        .sla-table td:last-child { font-size: 0.78rem; max-width: 420px; }
        .sla-table .yes { color: #3fb950; font-weight: 600; }
        .sla-table .no { color: #f85149; font-weight: 600; }
    </style>
</head>
<body>
    <h1>Databricks Feature Preview Status Tracker</h1>
    <p class="subtitle">Interactive view of Databricks preview features across workspace and account scopes. Click any row to expand discussion.<br>
        Made by <a href="https://cauchy.io" style="color:#58a6ff; text-decoration:none;">Cauchy</a>, a Databricks Partner.</p>

    <div class="disclaimer">
        <strong>Disclaimer:</strong> This is an independent, automated aggregation of Databricks preview feature information.
        Feature data is collected from the Databricks workspace/account preview pages and the Azure Databricks documentation on Microsoft Learn.
        All descriptions are copied verbatim from their respective sources. This overview is provided as-is for informational purposes only.
        Always consult the <a href="https://learn.microsoft.com/en-gb/azure/databricks/" style="color:#58a6ff">official Databricks documentation</a>
        and your workspace's Previews page as the authoritative source.
    </div>

    <details class="giscus-explainer">
        <summary>How do discussions work? (Powered by Giscus)</summary>
        <p>
            Each feature has its own discussion thread. Click the ðŸ’¬ icon on any row to expand it.
            Discussions are powered by <a href="https://giscus.app" style="color:#58a6ff">Giscus</a>,
            which uses <a href="https://github.com/CauchyIO/dbr_feature_status_tracker/discussions" style="color:#58a6ff">GitHub Discussions</a>
            as the backend &mdash; no separate account needed.
        </p>
        <p>
            <strong>When you comment for the first time</strong>, GitHub will ask you to authorize the Giscus app.
            Here's what that means:
        </p>
        <ul>
            <li>Giscus <strong>only</strong> requests permission to post discussion comments on your behalf. It cannot access your repos, code, or private data.</li>
            <li>Comments are posted as <strong>your GitHub identity</strong> directly to this repo's Discussions tab &mdash; you can verify them there at any time.</li>
            <li>Giscus is <a href="https://github.com/giscus/giscus" style="color:#58a6ff">fully open source</a> and stores no data itself. Everything lives in GitHub Discussions.</li>
            <li>You can <strong>revoke access</strong> at any time from <a href="https://github.com/settings/apps/authorizations" style="color:#58a6ff">GitHub &rarr; Settings &rarr; Applications</a>.</li>
        </ul>
    </details>

    <details class="sla-explainer">
        <summary>Release types &amp; SLA coverage</summary>
        <p style="margin: 10px 0 4px;">Source: <a href="https://learn.microsoft.com/en-gb/azure/databricks/release-notes/release-types" style="color:#58a6ff">Azure Databricks release types</a></p>
        <table class="sla-table">
            <thead>
                <tr>
                    <th>Release Type</th>
                    <th>Who Can Use?</th>
                    <th>Production?</th>
                    <th>Interface Stable?</th>
                    <th>SLA</th>
                    <th>Support</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-private-preview">PRIVATE_PREVIEW</span></td>
                    <td>Invite only</td>
                    <td class="no">No</td>
                    <td class="no">No</td>
                    <td class="no">No</td>
                    <td>Engineering team</td>
                    <td>Available by invite-only for a small set of customers. Previews are <strong>off</strong> by default. Admins can enable or disable the preview in workspaces. Often no accompanying documentation.</td>
                </tr>
                <tr>
                    <td><span class="badge badge-beta">BETA</span></td>
                    <td>Most customers</td>
                    <td class="no">No</td>
                    <td class="no">No</td>
                    <td class="no">No</td>
                    <td>Engineering team</td>
                    <td>Available to most customers. For Premium customers, Beta features are <strong>on</strong> by default. For Enterprise customers, Beta features are <strong>off</strong> by default. Admins can enable or disable on workspaces. Intended to advance to Public Preview or GA.</td>
                </tr>
                <tr>
                    <td><span class="badge badge-experimental">EXPERIMENTAL</span></td>
                    <td>Everyone</td>
                    <td class="no">No</td>
                    <td class="no">No</td>
                    <td class="no">No</td>
                    <td>Engineering team</td>
                    <td>Documented in Databricks documentation. The API might change.</td>
                </tr>
                <tr>
                    <td><span class="badge badge-public-preview">PUBLIC_PREVIEW</span></td>
                    <td>Everyone</td>
                    <td class="yes">Yes</td>
                    <td class="yes">Yes</td>
                    <td class="yes">Yes</td>
                    <td>Support team</td>
                    <td>Available to all customers. Admins can opt out by disabling in workspaces. Features are documented and stable, intended to advance to GA. A notification appears in the UI if GA is approaching soon.</td>
                </tr>
                <tr>
                    <td><span class="badge badge-ga">GA</span></td>
                    <td>Everyone</td>
                    <td class="yes">Yes</td>
                    <td class="yes">Yes</td>
                    <td class="yes">Yes</td>
                    <td>Support team</td>
                    <td>Generally available to all customers. Fully supported and production-ready.</td>
                </tr>
            </tbody>
        </table>
    </details>

    <details class="sla-explainer">
        <summary>What do the Source values mean?</summary>
        <table class="sla-table">
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Docs</strong></td>
                    <td>Scraped from the Azure Databricks documentation on Microsoft Learn.</td>
                </tr>
                <tr>
                    <td><strong>Workspace</strong></td>
                    <td>Scraped from the workspace-level Previews page in Databricks.</td>
                </tr>
                <tr>
                    <td><strong>Account</strong></td>
                    <td>Scraped from the account-level Previews page in Databricks.</td>
                </tr>
            </tbody>
        </table>
    </details>

    <div class="stats" id="stats"></div>

    <div class="chip-filters" id="chipFilters">
        <div class="chip-group" data-group="category">
            <div class="chip-group-header">
                <span class="chip-group-label">Category</span>
                <button class="chip-clear" type="button">Clear</button>
            </div>
            <div class="chip-container"></div>
        </div>
        <div class="chip-group" data-group="status">
            <div class="chip-group-header">
                <span class="chip-group-label">Status</span>
                <button class="chip-clear" type="button">Clear</button>
            </div>
            <div class="chip-container"></div>
        </div>
        <div class="chip-group" data-group="source">
            <div class="chip-group-header">
                <span class="chip-group-label">Source</span>
                <button class="chip-clear" type="button">Clear</button>
            </div>
            <div class="chip-container"></div>
        </div>
        <div class="chip-group" data-group="risk">
            <div class="chip-group-header">
                <span class="chip-group-label">Risk Level</span>
                <button class="chip-clear" type="button">Clear</button>
            </div>
            <div class="chip-container"></div>
        </div>
    </div>

    <table id="features" class="display" style="width:100%">
        <thead>
            <tr>
                <th title="Click to expand discussion">Discuss</th>
                <th>Category</th>
                <th>Feature</th>
                <th>Description</th>
                <th>Status (Azure)</th>
                <th>Risk (Human)</th>
                <th>Risk (AI)</th>
                <th>Source</th>
                <th>Last Checked</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
    <script>
        // Store raw data globally so child rows can access it
        let featureData = [];
        const filterState = { category: new Set(), status: new Set(), source: new Set(), risk: new Set() };

        function statusBadge(status) {
            if (!status || status === '-') return '-';
            const s = status.toUpperCase();
            let cls = '';
            if (s === 'GA') cls = 'badge-ga';
            else if (s.startsWith('GA_SOON')) cls = 'badge-ga-soon';
            else if (s.startsWith('PUBLIC_PREVIEW')) cls = 'badge-public-preview';
            else if (s.startsWith('BETA')) cls = 'badge-beta';
            else if (s.startsWith('PRIVATE_PREVIEW')) cls = 'badge-private-preview';
            else if (s.startsWith('EXPERIMENTAL')) cls = 'badge-experimental';
            else cls = 'badge-beta';
            return `<span class="badge ${cls}">${status}</span>`;
        }

        function riskBadge(risk) {
            if (!risk || risk === '-') return '-';
            const r = risk.toLowerCase();
            let cls = '';
            if (r.startsWith('high')) cls = 'risk-high';
            else if (r.startsWith('medium')) cls = 'risk-medium';
            else if (r.startsWith('low')) cls = 'risk-low';
            return `<span class="${cls}">${risk}</span>`;
        }

        function statusOrder(status) {
            if (!status || status === '-') return 99;
            const s = status.toUpperCase();
            if (s.startsWith('PRIVATE_PREVIEW')) return 0;
            if (s.startsWith('EXPERIMENTAL')) return 1;
            if (s.startsWith('BETA')) return 2;
            if (s.startsWith('PUBLIC_PREVIEW')) return 3;
            if (s.startsWith('GA_SOON')) return 4;
            if (s === 'GA') return 5;
            return 50;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (inQuotes) {
                    if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
                    else if (ch === '"') { inQuotes = false; }
                    else { current += ch; }
                } else {
                    if (ch === '"') { inQuotes = true; }
                    else if (ch === ',') { result.push(current); current = ''; }
                    else { current += ch; }
                }
            }
            result.push(current);
            return result;
        }

        async function loadCSV() {
            const resp = await fetch('features.csv');
            const text = await resp.text();
            const lines = text.trim().split('\n');
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                if (row.length >= 9) {
                    rows.push({
                        category: row[0], feature: row[1], url: row[2],
                        description: row[3], status: row[4], riskHuman: row[5],
                        riskAI: row[6], source: row[7], lastChecked: row[8]
                    });
                }
            }
            return rows;
        }

        function buildChildRow(d) {
            const docLink = d.url
                ? `<div class="detail-block"><strong>Docs:</strong> <a href="${d.url}" target="_blank" rel="noopener">${d.url}</a></div>`
                : '';
            const giscusId = `giscus-${btoa(d.feature).replace(/[^a-zA-Z0-9]/g, '')}`;
            const discussPageLink = `discuss.html?feature=${encodeURIComponent(d.feature)}`;
            return `
                <div class="child-content">
                    <div class="feature-detail">
                        <div class="detail-block"><strong>Category:</strong> ${d.category}</div>
                        <div class="detail-block"><strong>Status:</strong> ${statusBadge(d.status)}</div>
                        <div class="detail-block"><strong>Source:</strong> ${d.source}</div>
                        <div class="detail-block"><strong>Last Checked:</strong> ${d.lastChecked}</div>
                    </div>
                    ${docLink}
                    <div class="feature-description">${d.description}</div>
                    <div class="discuss-header">Discussion</div>
                    <div id="${giscusId}"></div>
                    <a class="open-discuss" href="${discussPageLink}">Open full discussion page &rarr;</a>
                </div>
            `;
        }

        function loadGiscus(featureName, containerId) {
            const container = document.getElementById(containerId);
            if (!container || container.dataset.loaded) return;
            container.dataset.loaded = 'true';

            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.setAttribute('data-repo', 'CauchyIO/dbr_feature_status_tracker');
            script.setAttribute('data-repo-id', 'R_kgDORJj__g');
            script.setAttribute('data-category', 'General');
            script.setAttribute('data-category-id', 'DIC_kwDORJj__s4C2FlB');
            script.setAttribute('data-mapping', 'specific');
            script.setAttribute('data-term', featureName);
            script.setAttribute('data-strict', '0');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata', '0');
            script.setAttribute('data-input-position', 'top');
            script.setAttribute('data-theme', 'dark_tritanopia');
            script.setAttribute('data-lang', 'en');
            script.setAttribute('crossorigin', 'anonymous');
            script.async = true;
            container.appendChild(script);
        }

        $(async function () {
            featureData = await loadCSV();

            // Derive unique values and counts for chip filters
            const categories = [...new Set(featureData.map(d => d.category))].sort();
            const statuses = [...new Set(featureData.map(d => d.status))].filter(s => s && s !== '-').sort();
            const sources = [...new Set(featureData.map(d => d.source))].filter(s => s && s !== '-').sort();
            const risks = ['High', 'Medium', 'Low'];

            function countValues(field, value) {
                if (field === 'risk') {
                    const v = value.toLowerCase();
                    return featureData.filter(d => {
                        const rh = (d.riskHuman || '').toLowerCase();
                        const ra = (d.riskAI || '').toLowerCase();
                        return rh.startsWith(v) || ra.startsWith(v);
                    }).length;
                }
                return featureData.filter(d => d[field] === value).length;
            }

            function statusChipClass(s) {
                const u = s.toUpperCase();
                if (u === 'GA') return 'chip-ga';
                if (u.startsWith('GA_SOON')) return 'chip-ga-soon';
                if (u.startsWith('PUBLIC_PREVIEW')) return 'chip-public-preview';
                if (u.startsWith('BETA')) return 'chip-beta';
                if (u.startsWith('PRIVATE_PREVIEW')) return 'chip-private-preview';
                if (u.startsWith('EXPERIMENTAL')) return 'chip-experimental';
                return 'chip-accent';
            }

            function riskChipClass(r) {
                const l = r.toLowerCase();
                if (l === 'high') return 'chip-risk-high';
                if (l === 'medium') return 'chip-risk-medium';
                if (l === 'low') return 'chip-risk-low';
                return 'chip-accent';
            }

            function buildChips() {
                const groups = {
                    category: { values: categories, field: 'category', colorFn: () => 'chip-accent' },
                    status:   { values: statuses,   field: 'status',   colorFn: statusChipClass },
                    source:   { values: sources,    field: 'source',   colorFn: () => 'chip-accent' },
                    risk:     { values: risks,      field: 'risk',     colorFn: riskChipClass }
                };
                for (const [group, cfg] of Object.entries(groups)) {
                    const container = document.querySelector(`.chip-group[data-group="${group}"] .chip-container`);
                    container.innerHTML = '';
                    cfg.values.forEach(val => {
                        const count = countValues(cfg.field, val);
                        const colorCls = cfg.colorFn(val);
                        const active = filterState[group].has(val) ? ' active' : '';
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = `chip ${colorCls}${active}`;
                        btn.dataset.group = group;
                        btn.dataset.value = val;
                        btn.innerHTML = `${val} <span class="chip-count">${count}</span>`;
                        container.appendChild(btn);
                    });
                }
            }

            buildChips();

            // Stats
            const total = featureData.length;
            const catCount = categories.length;
            const gaCount = featureData.filter(d => d.status === 'GA').length;
            const ppCount = featureData.filter(d => d.status.startsWith('PUBLIC_PREVIEW')).length;
            const betaCount = featureData.filter(d => d.status.startsWith('BETA')).length;
            $('#stats').html(`
                <div class="stat-card"><div class="number">${total}</div><div class="label">Total Features</div></div>
                <div class="stat-card"><div class="number">${catCount}</div><div class="label">Categories</div></div>
                <div class="stat-card"><div class="number badge-ga" style="background:transparent;color:#3fb950">${gaCount}</div><div class="label">GA</div></div>
                <div class="stat-card"><div class="number" style="color:#58a6ff">${ppCount}</div><div class="label">Public Preview</div></div>
                <div class="stat-card"><div class="number" style="color:#d29922">${betaCount}</div><div class="label">Beta</div></div>
            `);

            // Build table data â€” column 0 is null (toggle control)
            const tableData = featureData.map((d, idx) => {
                const featureCell = d.url
                    ? `<a href="${d.url}" target="_blank" rel="noopener">${d.feature}</a>`
                    : d.feature;
                return {
                    idx: idx,
                    toggle: null,
                    category: d.category,
                    featureHtml: featureCell,
                    description: d.description,
                    statusHtml: statusBadge(d.status),
                    riskHumanHtml: riskBadge(d.riskHuman),
                    riskAIHtml: riskBadge(d.riskAI),
                    source: d.source,
                    lastChecked: d.lastChecked,
                    statusRaw: d.status
                };
            });

            const table = $('#features').DataTable({
                data: tableData,
                pageLength: 25,
                order: [[1, 'asc'], [4, 'asc']],
                columns: [
                    { data: 'toggle', defaultContent: '<svg class="discuss-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M1 2.75C1 1.784 1.784 1 2.75 1h10.5c.966 0 1.75.784 1.75 1.75v7.5A1.75 1.75 0 0 1 13.25 12H9.06l-2.573 2.573A1.458 1.458 0 0 1 4 13.543V12H2.75A1.75 1.75 0 0 1 1 10.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h4.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg>', className: 'dt-control', orderable: false, searchable: false, width: '32px' },
                    { data: 'category' },
                    { data: 'featureHtml' },
                    { data: 'description', className: 'dt-body-left', width: '35%' },
                    { data: 'statusHtml' },
                    { data: 'riskHumanHtml' },
                    { data: 'riskAIHtml' },
                    { data: 'source' },
                    { data: 'lastChecked' }
                ],
                columnDefs: [
                    {
                        targets: 4,
                        type: 'num',
                        render: {
                            sort: function (data) {
                                const tmp = document.createElement('span');
                                tmp.innerHTML = data;
                                return statusOrder(tmp.textContent);
                            }
                        }
                    }
                ],
                language: {
                    search: 'Search:',
                    lengthMenu: 'Show _MENU_ features',
                    info: 'Showing _START_ to _END_ of _TOTAL_ features',
                    infoFiltered: '(filtered from _MAX_ total)',
                    zeroRecords: 'No matching features found'
                }
            });

            // Expand/collapse child row on toggle click
            $('#features tbody').on('click', 'td.dt-control', function () {
                const tr = $(this).closest('tr');
                const row = table.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    const d = featureData[row.data().idx];
                    row.child(buildChildRow(d)).show();
                    tr.addClass('shown');
                    tr.next('tr').addClass('child-row');

                    // Load giscus on demand
                    const giscusId = `giscus-${btoa(d.feature).replace(/[^a-zA-Z0-9]/g, '')}`;
                    loadGiscus(d.feature, giscusId);
                }
            });

            // Multi-select chip filters: OR within group, AND between groups
            function applyFilters() {
                const esc = $.fn.dataTable.util.escapeRegex;

                // Category (col 1): exact match OR
                if (filterState.category.size) {
                    const re = [...filterState.category].map(v => esc(v)).join('|');
                    table.column(1).search(`^(${re})$`, true, false);
                } else {
                    table.column(1).search('', true, false);
                }

                // Source (col 7): unanchored OR (handles compound values like "Account, Docs")
                if (filterState.source.size) {
                    const re = [...filterState.source].map(v => esc(v)).join('|');
                    table.column(7).search(re, true, false);
                } else {
                    table.column(7).search('', true, false);
                }

                // Status (col 4): unanchored OR
                if (filterState.status.size) {
                    const re = [...filterState.status].map(v => esc(v)).join('|');
                    table.column(4).search(re, true, false);
                } else {
                    table.column(4).search('', true, false);
                }

                // Risk (cols 5+6): custom ext.search with prefix matching against Set
                $.fn.dataTable.ext.search.length = 0;
                if (filterState.risk.size) {
                    const riskVals = new Set([...filterState.risk].map(v => v.toLowerCase()));
                    $.fn.dataTable.ext.search.push(function (settings, searchData) {
                        const rh = (searchData[5] || '').toLowerCase();
                        const ra = (searchData[6] || '').toLowerCase();
                        for (const rv of riskVals) {
                            if (rh.startsWith(rv) || ra.startsWith(rv)) return true;
                        }
                        return false;
                    });
                }

                table.draw();
                updateURL();
            }

            // Update Clear button visibility for a group
            function updateClearBtn(group) {
                const btn = document.querySelector(`.chip-group[data-group="${group}"] .chip-clear`);
                btn.classList.toggle('visible', filterState[group].size > 0);
            }

            // Chip click: toggle selection
            document.getElementById('chipFilters').addEventListener('click', function (e) {
                const chip = e.target.closest('.chip');
                if (chip) {
                    const group = chip.dataset.group;
                    const value = chip.dataset.value;
                    if (filterState[group].has(value)) {
                        filterState[group].delete(value);
                        chip.classList.remove('active');
                    } else {
                        filterState[group].add(value);
                        chip.classList.add('active');
                    }
                    updateClearBtn(group);
                    applyFilters();
                    return;
                }
                const clearBtn = e.target.closest('.chip-clear');
                if (clearBtn) {
                    const group = clearBtn.closest('.chip-group').dataset.group;
                    filterState[group].clear();
                    clearBtn.closest('.chip-group').querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    clearBtn.classList.remove('visible');
                    applyFilters();
                }
            });

            // URL hash state
            function updateURL() {
                const params = {};
                for (const [group, vals] of Object.entries(filterState)) {
                    if (vals.size) params[group] = [...vals].join(',');
                }
                const hash = new URLSearchParams(params).toString();
                history.replaceState(null, '', hash ? `#${hash}` : location.pathname + location.search);
            }

            function restoreFromURL() {
                const hash = location.hash.slice(1);
                if (!hash) return;
                const params = new URLSearchParams(hash);
                for (const [group, vals] of params.entries()) {
                    if (filterState.hasOwnProperty(group)) {
                        vals.split(',').forEach(v => filterState[group].add(v));
                    }
                }
                // Sync chip UI
                document.querySelectorAll('.chip').forEach(chip => {
                    const g = chip.dataset.group;
                    const v = chip.dataset.value;
                    if (filterState[g] && filterState[g].has(v)) chip.classList.add('active');
                });
                for (const group of Object.keys(filterState)) updateClearBtn(group);
                applyFilters();
            }

            restoreFromURL();
        });
    </script>

</body>
</html>
