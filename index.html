<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Databricks Feature Preview Status Tracker</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            padding: 24px;
        }
        h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #8b949e;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        .disclaimer {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .filters select {
            background: #161b22;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .filters select:focus { outline: 1px solid #58a6ff; border-color: #58a6ff; }

        /* DataTables overrides for dark theme */
        table.dataTable { border-collapse: collapse; width: 100% !important; }
        table.dataTable thead th {
            background: #161b22;
            color: #e6edf3;
            border-bottom: 1px solid #30363d;
            padding: 10px 12px;
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
        }
        table.dataTable tbody td {
            background: #0d1117;
            color: #e6edf3;
            border-bottom: 1px solid #21262d;
            padding: 8px 12px;
            font-size: 0.82rem;
            vertical-align: top;
        }
        table.dataTable tbody tr:hover td { background: #161b22; }
        table.dataTable tbody td:nth-child(3) { max-width: 420px; } /* description */
        table.dataTable tbody td a {
            color: #58a6ff;
            text-decoration: none;
        }
        table.dataTable tbody td a:hover { text-decoration: underline; }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-ga { background: #238636; color: #fff; }
        .badge-ga-soon { background: #1a7f37; color: #d3f5d8; border: 1px dashed #3fb950; }
        .badge-public-preview { background: #1f3a5f; color: #58a6ff; }
        .badge-beta { background: #4a2c0a; color: #d29922; }
        .badge-private-preview { background: #3d1e5c; color: #bc8cff; }
        .badge-experimental { background: #3d1e1e; color: #f47067; }

        /* Risk badges */
        .risk-high { color: #f85149; font-weight: 600; }
        .risk-medium { color: #d29922; }
        .risk-low { color: #3fb950; }

        /* DataTables search & info */
        .dt-search { margin-bottom: 12px; }
        .dt-search input {
            background: #161b22;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        .dt-search input:focus { outline: 1px solid #58a6ff; border-color: #58a6ff; }
        .dt-search label { color: #8b949e; font-size: 0.85rem; }
        .dt-info { color: #8b949e; font-size: 0.82rem; padding: 8px 0; }
        .dt-paging { padding: 12px 0; }
        .dt-paging button {
            background: #161b22;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 4px 10px;
            margin: 0 2px;
            cursor: pointer;
            font-size: 0.82rem;
        }
        .dt-paging button:hover { border-color: #58a6ff; }
        .dt-paging button.current { background: #58a6ff; color: #0d1117; border-color: #58a6ff; }
        .dt-paging button.disabled { opacity: 0.4; cursor: default; }
        .dt-length { color: #8b949e; font-size: 0.82rem; margin-bottom: 8px; }
        .dt-length select {
            background: #161b22;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 4px 8px;
        }

        .stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px 20px;
            text-align: center;
        }
        .stat-card .number { font-size: 1.4rem; font-weight: 700; }
        .stat-card .label { font-size: 0.75rem; color: #8b949e; margin-top: 2px; }
    </style>
</head>
<body>
    <h1>Databricks Feature Preview Status Tracker</h1>
    <p class="subtitle">Interactive view of Databricks preview features across workspace and account scopes.</p>

    <div class="disclaimer">
        <strong>Disclaimer:</strong> This is an independent, automated aggregation of Databricks preview feature information.
        Feature data is collected from the Databricks workspace/account preview pages and the Azure Databricks documentation on Microsoft Learn.
        All descriptions are copied verbatim from their respective sources. This overview is provided as-is for informational purposes only.
        Always consult the <a href="https://learn.microsoft.com/en-gb/azure/databricks/" style="color:#58a6ff">official Databricks documentation</a>
        and your workspace's Previews page as the authoritative source.
    </div>

    <div class="stats" id="stats"></div>

    <div class="filters">
        <select id="filterCategory"><option value="">All Categories</option></select>
        <select id="filterStatus"><option value="">All Statuses</option></select>
        <select id="filterSource"><option value="">All Sources</option></select>
        <select id="filterRisk"><option value="">All Risk Levels</option></select>
    </div>

    <table id="features" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Category</th>
                <th>Feature</th>
                <th>Description</th>
                <th>Status (Azure)</th>
                <th>Risk (Human)</th>
                <th>Risk (AI)</th>
                <th>Source</th>
                <th>Last Checked</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
    <script>
        function statusBadge(status) {
            if (!status || status === '-') return '-';
            const s = status.toUpperCase();
            let cls = '';
            if (s === 'GA') cls = 'badge-ga';
            else if (s.startsWith('GA_SOON')) cls = 'badge-ga-soon';
            else if (s.startsWith('PUBLIC_PREVIEW')) cls = 'badge-public-preview';
            else if (s.startsWith('BETA')) cls = 'badge-beta';
            else if (s.startsWith('PRIVATE_PREVIEW')) cls = 'badge-private-preview';
            else if (s.startsWith('EXPERIMENTAL')) cls = 'badge-experimental';
            else cls = 'badge-beta';
            return `<span class="badge ${cls}">${status}</span>`;
        }

        function riskBadge(risk) {
            if (!risk || risk === '-') return '-';
            const r = risk.toLowerCase();
            let cls = '';
            if (r.startsWith('high')) cls = 'risk-high';
            else if (r.startsWith('medium')) cls = 'risk-medium';
            else if (r.startsWith('low')) cls = 'risk-low';
            return `<span class="${cls}">${risk}</span>`;
        }

        function statusOrder(status) {
            if (!status || status === '-') return 99;
            const s = status.toUpperCase();
            if (s.startsWith('PRIVATE_PREVIEW')) return 0;
            if (s.startsWith('EXPERIMENTAL')) return 1;
            if (s.startsWith('BETA')) return 2;
            if (s.startsWith('PUBLIC_PREVIEW')) return 3;
            if (s.startsWith('GA_SOON')) return 4;
            if (s === 'GA') return 5;
            return 50;
        }

        async function loadCSV() {
            const resp = await fetch('features.csv');
            const text = await resp.text();
            const lines = text.trim().split('\n');
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                if (row.length >= 9) {
                    rows.push({
                        category: row[0],
                        feature: row[1],
                        url: row[2],
                        description: row[3],
                        status: row[4],
                        riskHuman: row[5],
                        riskAI: row[6],
                        source: row[7],
                        lastChecked: row[8]
                    });
                }
            }
            return rows;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (inQuotes) {
                    if (ch === '"' && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else if (ch === '"') {
                        inQuotes = false;
                    } else {
                        current += ch;
                    }
                } else {
                    if (ch === '"') {
                        inQuotes = true;
                    } else if (ch === ',') {
                        result.push(current);
                        current = '';
                    } else {
                        current += ch;
                    }
                }
            }
            result.push(current);
            return result;
        }

        $(async function () {
            const data = await loadCSV();

            // Populate filter dropdowns
            const categories = [...new Set(data.map(d => d.category))].sort();
            const statuses = [...new Set(data.map(d => d.status))].filter(s => s && s !== '-').sort();
            const sources = [...new Set(data.map(d => d.source))].filter(s => s && s !== '-').sort();
            const risks = ['High', 'Medium', 'Low'];

            categories.forEach(c => $('#filterCategory').append(`<option value="${c}">${c}</option>`));
            statuses.forEach(s => $('#filterStatus').append(`<option value="${s}">${s}</option>`));
            sources.forEach(s => $('#filterSource').append(`<option value="${s}">${s}</option>`));
            risks.forEach(r => $('#filterRisk').append(`<option value="${r}">${r}</option>`));

            // Stats
            const total = data.length;
            const catCount = categories.length;
            const gaCount = data.filter(d => d.status === 'GA').length;
            const ppCount = data.filter(d => d.status.startsWith('PUBLIC_PREVIEW')).length;
            const betaCount = data.filter(d => d.status.startsWith('BETA')).length;
            $('#stats').html(`
                <div class="stat-card"><div class="number">${total}</div><div class="label">Total Features</div></div>
                <div class="stat-card"><div class="number">${catCount}</div><div class="label">Categories</div></div>
                <div class="stat-card"><div class="number badge-ga" style="background:transparent;color:#3fb950">${gaCount}</div><div class="label">GA</div></div>
                <div class="stat-card"><div class="number" style="color:#58a6ff">${ppCount}</div><div class="label">Public Preview</div></div>
                <div class="stat-card"><div class="number" style="color:#d29922">${betaCount}</div><div class="label">Beta</div></div>
            `);

            // DataTable
            const tableData = data.map(d => {
                const featureCell = d.url
                    ? `<a href="${d.url}" target="_blank" rel="noopener">${d.feature}</a>`
                    : d.feature;
                return [
                    d.category,
                    featureCell,
                    d.description,
                    statusBadge(d.status),
                    riskBadge(d.riskHuman),
                    riskBadge(d.riskAI),
                    d.source,
                    d.lastChecked
                ];
            });

            const table = $('#features').DataTable({
                data: tableData,
                pageLength: 25,
                order: [[0, 'asc'], [3, 'asc']],
                columnDefs: [
                    { targets: 2, className: 'dt-body-left', width: '35%' },
                    {
                        targets: 3,
                        type: 'num',
                        render: {
                            sort: function (data) {
                                const tmp = document.createElement('span');
                                tmp.innerHTML = data;
                                return statusOrder(tmp.textContent);
                            }
                        }
                    }
                ],
                language: {
                    search: 'Search:',
                    lengthMenu: 'Show _MENU_ features',
                    info: 'Showing _START_ to _END_ of _TOTAL_ features',
                    infoFiltered: '(filtered from _MAX_ total)',
                    zeroRecords: 'No matching features found'
                }
            });

            // Custom column filters
            function applyFilters() {
                const cat = $('#filterCategory').val();
                const status = $('#filterStatus').val();
                const source = $('#filterSource').val();
                const risk = $('#filterRisk').val();

                table.column(0).search(cat ? `^${$.fn.dataTable.util.escapeRegex(cat)}$` : '', true, false);
                table.column(6).search(source ? `^${$.fn.dataTable.util.escapeRegex(source)}$` : '', true, false);

                if (status) {
                    table.column(3).search($.fn.dataTable.util.escapeRegex(status), true, false);
                } else {
                    table.column(3).search('', true, false);
                }

                if (risk) {
                    // Search across both risk columns (4 and 5)
                    const re = risk.toLowerCase();
                    $.fn.dataTable.ext.search.length = 0; // clear custom filters
                    if (risk) {
                        $.fn.dataTable.ext.search.push(function (settings, searchData) {
                            const rh = (searchData[4] || '').toLowerCase();
                            const ra = (searchData[5] || '').toLowerCase();
                            return rh.startsWith(re) || ra.startsWith(re);
                        });
                    }
                } else {
                    $.fn.dataTable.ext.search.length = 0;
                }

                table.draw();
            }

            $('#filterCategory, #filterStatus, #filterSource, #filterRisk').on('change', applyFilters);
        });
    </script>
</body>
</html>
